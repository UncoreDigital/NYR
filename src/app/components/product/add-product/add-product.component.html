<div class="page-layout">
    <app-sidebar></app-sidebar>
    <div class="main-content">
        <app-header></app-header>
        <div class="content">
            <!-- Breadcrumb -->
            <div class="breadcrumb flex items-center space-x-2 text-gray-600">
                <!-- <a routerLink="/product" class="breadcrumb-item hover:text-blue-600 cursor-pointer active">
                    Settings
                </a>
                <mat-icon class="breadcrumb-separator text-gray-400">chevron_right</mat-icon> -->

                <a routerLink="/product" class="breadcrumb-item hover:text-blue-600 cursor-pointer active">
                    Product
                </a>
                <mat-icon class="breadcrumb-separator text-gray-400">chevron_right</mat-icon>

                <span class="breadcrumb-item text-gray-800 font-semibold active">
                    Add Product
                </span>
            </div>

            <!-- Page Header -->
            <div class="page-header">
                <h1>{{ isEditMode ? 'Edit Product' : 'Add New Product' }}</h1>
            </div>

            <div class="table-container">
                <!-- Loading Overlay -->
                <div *ngIf="isLoading" class="loading-overlay">
                    <div class="loading-content">
                        <div class="loading-spinner-large"></div>
                        <p>{{ isEditMode ? 'Updating product...' : 'Adding product...' }}</p>
                    </div>
                </div>

                <!-- Product Loading Overlay -->
                <div *ngIf="isLoadingProduct" class="loading-overlay">
                    <div class="loading-content">
                        <div class="loading-spinner-large"></div>
                        <p>Loading product...</p>
                    </div>
                </div>
                
                <form [formGroup]="productForm" class="user-form" (ngSubmit)="onSubmit()" [class.loading]="isLoading">
                    <div style="display:flex; gap:32px;">
                        <!-- Left Column -->
                        <div style="flex:2;">
                            <div class="form-group">
                                <label>Product Name*</label>
                                <input type="text" formControlName="productName" class="form-control"
                                    placeholder="Enter product name" />
                            </div>
                            <div class="form-group">
                                <label>Description*</label>
                                <textarea formControlName="description" class="form-control" rows="3"
                                    placeholder="Description"></textarea>
                            </div>
                        </div>
                        <!-- Right Column: Upload Image -->
                        <div style="flex:1;">
                            <label style="font-weight:500;">Upload Image</label>
                            
                            <!-- Image Preview -->
                            <div *ngIf="imagePreview" class="image-preview-container">
                                <img [src]="imagePreview" alt="Product Preview" class="image-preview">
                                <button type="button" class="remove-image-btn" (click)="removeImage()" title="Remove Image">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </div>
                            
                            <!-- Upload Area -->
                            <div *ngIf="!imagePreview" 
                                class="upload-area" 
                                [class.uploading]="isUploadingImage"
                                (click)="fileInput.click()">
                                <input #fileInput type="file" accept="image/*" (change)="onImageSelected($event)" style="display: none;">
                                
                                <div *ngIf="!isUploadingImage" class="upload-content">
                                    <mat-icon class="upload-icon" style="height: fit-content; width: fit-content;">cloud_upload</mat-icon>
                                    <span class="upload-text">Click to browse or drag & drop</span>
                                    <span class="upload-hint">Supports: JPEG, PNG, GIF, WebP (Max 5MB)</span>
                                </div>
                                
                                <div *ngIf="isUploadingImage" class="upload-loading">
                                    <div class="upload-spinner"></div>
                                    <span>Processing image...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Barcode (SKU)</label>
                            <div class="sku-input-container">
                                <input type="text" formControlName="sku1" class="sku-input"
                                    placeholder="Enter SKU" />
                                <button type="button" class="camera-btn" title="Scan barcode with camera">
                                    <mat-icon>photo_camera</mat-icon>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Barcode (SKU #2)</label>
                            <div class="sku-input-container">
                                <input type="text" class="sku-input" formControlName="sku2"
                                    placeholder="Enter SKU" />
                                <button type="button" class="camera-btn" title="Scan barcode with camera">
                                    <mat-icon>photo_camera</mat-icon>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex:1;">
                            <label>Barcode (SKU #3)</label>
                            <div class="sku-input-container">
                                <input type="text" class="sku-input" formControlName="sku3"
                                    placeholder="Enter SKU" />
                                <button type="button" class="camera-btn" title="Scan barcode with camera">
                                    <mat-icon>photo_camera</mat-icon>
                                </button>
                            </div>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>Barcode (SKU #4)</label>
                            <div class="sku-input-container">
                                <input type="text" class="sku-input" formControlName="sku4"
                                    placeholder="Enter SKU" />
                                <button type="button" class="camera-btn" title="Scan barcode with camera">
                                    <mat-icon>photo_camera</mat-icon>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Category</label>
                            <div class="custom-select-container" *ngIf="!isLoadingDropdowns">
                                <div class="search-wrapper" (click)="showCategoryDropdown = true">
                                    <mat-icon class="search-icon">search</mat-icon>
                                    <input 
                                        type="text" 
                                        class="search-input" 
                                        placeholder="Select a Category"
                                        [value]="categorySearchTerm"
                                        (input)="onCategorySearchInput($event); filterCategories()"
                                        (focus)="showCategoryDropdown = true"
                                        (blur)="hideCategoryDropdown()"
                                        [readonly]="selectedCategory ? true : false"
                                    >
                                    <button 
                                        *ngIf="selectedCategory" 
                                        type="button" 
                                        class="clear-button"
                                        (click)="clearCategory(); $event.stopPropagation()"
                                    >
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showCategoryDropdown && !selectedCategory">
                                    <div 
                                        class="dropdown-item" 
                                        *ngFor="let category of getFilteredCategories()"
                                        (click)="selectCategory(category)"
                                        [class.selected]="selectedCategory?.id === category.id"
                                    >
                                        {{ category.name }}
                                    </div>
                                    <div *ngIf="getFilteredCategories().length === 0" class="no-results">
                                        No categories found
                                    </div>
                                </div>
                            </div>
                            <div *ngIf="isLoadingDropdowns" class="dropdown-loading">
                                <span class="loading-text">Loading categories...</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Brand</label>
                            <div class="custom-select-container" *ngIf="!isLoadingDropdowns">
                                <div class="search-wrapper" (click)="showBrandDropdown = true">
                                    <mat-icon class="search-icon">search</mat-icon>
                                    <input 
                                        type="text" 
                                        class="search-input" 
                                        placeholder="Select a Brand"
                                        [value]="brandSearchTerm"
                                        (input)="onBrandSearchInput($event); filterBrands()"
                                        (focus)="showBrandDropdown = true"
                                        (blur)="hideBrandDropdown()"
                                        [readonly]="selectedBrand ? true : false"
                                    >
                                    <button 
                                        *ngIf="selectedBrand" 
                                        type="button" 
                                        class="clear-button"
                                        (click)="clearBrand(); $event.stopPropagation()"
                                    >
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showBrandDropdown && !selectedBrand">
                                    <div 
                                        class="dropdown-item" 
                                        *ngFor="let brand of getFilteredBrands()"
                                        (click)="selectBrand(brand)"
                                        [class.selected]="selectedBrand?.id === brand.id"
                                    >
                                        {{ brand.name }}
                                    </div>
                                    <div *ngIf="getFilteredBrands().length === 0" class="no-results">
                                        No brands found
                                    </div>
                                </div>
                            </div>
                            <div *ngIf="isLoadingDropdowns" class="dropdown-loading">
                                <span class="loading-text">Loading brands...</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex:1;">
                            <label>Supplier</label>
                            <div class="custom-select-container" *ngIf="!isLoadingDropdowns">
                                <div class="search-wrapper" (click)="showSupplierDropdown = true">
                                    <mat-icon class="search-icon">search</mat-icon>
                                    <input 
                                        type="text" 
                                        class="search-input" 
                                        placeholder="Select a Supplier"
                                        [value]="supplierSearchTerm"
                                        (input)="onSupplierSearchInput($event); filterSuppliers()"
                                        (focus)="showSupplierDropdown = true"
                                        (blur)="hideSupplierDropdown()"
                                        [readonly]="selectedSupplier ? true : false"
                                    >
                                    <button 
                                        *ngIf="selectedSupplier" 
                                        type="button" 
                                        class="clear-button"
                                        (click)="clearSupplier(); $event.stopPropagation()"
                                    >
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showSupplierDropdown && !selectedSupplier">
                                    <div 
                                        class="dropdown-item supplier-item" 
                                        *ngFor="let supplier of getFilteredSuppliers()"
                                        (click)="selectSupplier(supplier)"
                                        [class.selected]="selectedSupplier?.id === supplier.id"
                                    >
                                        <div class="supplier-main-info">
                                            <div class="supplier-name">{{ supplier.name }}</div>
                                            <div class="supplier-contact" *ngIf="supplier.contactPerson">
                                                Contact: {{ supplier.contactPerson }}
                                            </div>
                                        </div>
                                        <div class="supplier-details" *ngIf="supplier.email || supplier.phoneNumber">
                                            <div class="supplier-email" *ngIf="supplier.email">{{ supplier.email }}</div>
                                            <div class="supplier-phone" *ngIf="supplier.phoneNumber">{{ supplier.phoneNumber }}</div>
                                        </div>
                                    </div>
                                    <div *ngIf="getFilteredSuppliers().length === 0" class="no-results">
                                        No suppliers found
                                    </div>
                                </div>
                            </div>
                            <div *ngIf="isLoadingDropdowns" class="dropdown-loading">
                                <span class="loading-text">Loading suppliers...</span>
                            </div>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>Price*</label>
                            <input type="text" formControlName="price" class="form-control" placeholder="Enter Price" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom: 20px;">
                            <label style="font-weight:500;">Show in Catalogue</label>
                            <mat-slide-toggle formControlName="showInCatalogue"></mat-slide-toggle>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom: 20px">
                            <label style="font-weight:500;">Universal</label>
                            <mat-slide-toggle (change)="onUniversalToggle($event)"></mat-slide-toggle>
                        </div>
                    </div>
                    <div class="form-row" *ngIf="!universal">
                        <div class="form-group" style="flex:1;">
                            <label>Add Variation</label>
                            <div class="multi-select-dropdown" [class.active]="showVariationDropdown">
                                <div class="multi-select-trigger" (click)="toggleVariationDropdown($event)">
                                    <span class="selected-text">
                                        <span *ngIf="selectedVariations.length === 0" class="placeholder">Select Variation</span>
                                        <span *ngIf="selectedVariations.length === 1">{{ selectedVariations[0].name }}</span>
                                        <span *ngIf="selectedVariations.length > 1">{{ selectedVariations.length }} variations selected</span>
                                    </span>
                                    <mat-icon class="dropdown-arrow" [class.rotated]="showVariationDropdown">expand_more</mat-icon>
                                </div>
                                <div class="multi-select-dropdown-menu" *ngIf="showVariationDropdown">
                                    <div class="multi-select-option" *ngFor="let variation of availableVariations" 
                                         (mousedown)="toggleVariationSelection(variation); $event.preventDefault()">
                                        <input type="checkbox" 
                                               [checked]="isVariationSelected(variation)"
                                               readonly>
                                        <span>{{ variation.name }} <span class="variation-type-badge">({{ variation.valueType }})</span></span>
                                    </div>
                                    <div *ngIf="availableVariations.length === 0" class="no-variations-message">
                                        <p>No variations available. Please create variations in the Variation Master module first.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-outline" style="height:40px; width:40px; padding:0;"
                                (click)="addVariationClick()" title="Create new variation in Variation Master">
                                <mat-icon>add</mat-icon>
                            </button>
                        </div>
                    </div>

                    <!-- Selected Variations Table Grid -->
                    <div class="selected-variations-section" *ngIf="selectedVariations.length > 0 && !universal">
                        <div class="section-header">
                            <h3>Selected Variations</h3>
                            <p>Configure options for each selected variation</p>
                        </div>
                        <div class="variations-table-container">
                            <table class="variations-table">
                                <thead>
                                    <tr>
                                        <th class="variation-name-header">Variation Name</th>
                                        <th class="variation-type-header">Type</th>
                                        <th class="variation-options-header">Available Options</th>
                                        <th class="mandatory-header">Mandatory</th>
                                        <th class="actions-header">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="variation-row" *ngFor="let variation of selectedVariations; let i = index">
                                        <td class="variation-name-cell">
                                            <div class="variation-name">
                                                <mat-icon class="variation-icon">category</mat-icon>
                                                <span class="variation-text">{{ variation.name }}</span>
                                            </div>
                                        </td>
                                        <td class="variation-type-cell">
                                            <span class="type-badge" [class.dropdown]="variation.valueType === 'Dropdown'" [class.textinput]="variation.valueType === 'TextInput'">
                                                {{ variation.valueType }}
                                            </span>
                                        </td>
                                        <td class="variation-options-cell">
                                            <!-- Dropdown Options -->
                                            <div *ngIf="variation.valueType === 'Dropdown'" class="options-list">
                                                <span class="option-chip" *ngFor="let option of variation.options">
                                                    {{ option.name }}
                                                </span>
                                            </div>
                                            <!-- TextInput Info -->
                                            <div *ngIf="variation.valueType === 'TextInput'" class="text-input-info">
                                                <span class="text-input-label">Free text input</span>
                                            </div>
                                        </td>
                                        <td class="mandatory-cell">
                                            <label class="checkbox-container">
                                                <input type="checkbox" 
                                                       [(ngModel)]="variation.mandatory"
                                                       (change)="updateVariationMandatory(i, $event)"
                                                       class="mandatory-checkbox">
                                                <span class="checkmark"></span>
                                            </label>
                                        </td>
                                        <td class="actions-cell">
                                            <button type="button" 
                                                    class="remove-btn" 
                                                    (click)="removeSelectedVariation(i)" 
                                                    title="Remove variation">
                                                <mat-icon>delete</mat-icon>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" [disabled]="isLoading">
                            <span *ngIf="isLoading" class="loading-spinner"></span>
                            {{ isLoading ? (isEditMode ? 'Updating Product...' : 'Adding Product...') : (isEditMode ? 'Update Product' : 'Add Product') }}
                        </button>
                        <button type="button" class="btn btn-outline" [disabled]="isLoading" (click)="onCancel()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Quick Add Variation Modal -->
<div class="modal-backdrop" id="addVariation" *ngIf="addVariation">
    <div class="variation-modal">
        <div class="variation-header">
            <h2>Quick Add Variation</h2>
            <button type="button" class="close-btn" (click)="closeProductAvailability()">
                <mat-icon>close</mat-icon>
            </button>
        </div>
        
        <div class="variation-content">
            <!-- Variation Name -->
            <div class="form-group">
                <label>Variation Name <span class="required">*</span></label>
                <input type="text" [(ngModel)]="variationNm" class="form-control" 
                       placeholder="e.g., Size, Color, Material, etc." />
                <div *ngIf="!variationNm.trim() && variationNm !== ''" class="error-message">
                    Variation name is required
                </div>
            </div>

            <!-- Value Type Selection -->
            <div class="form-group">
                <label>Value Type <span class="required">*</span></label>
                <div class="value-type-options">
                    <div class="value-type-option" 
                         [class.active]="selectedValueType === 'dropdown'"
                         (click)="selectValueType('dropdown')">
                        <mat-icon>arrow_drop_down</mat-icon>
                        <div class="option-content">
                            <div class="option-title">Dropdown Options</div>
                            <div class="option-desc">Predefined set of options (e.g., S, M, L, XL)</div>
                        </div>
                    </div>
                    <div class="value-type-option" 
                         [class.active]="selectedValueType === 'text'"
                         (click)="selectValueType('text')">
                        <mat-icon>text_fields</mat-icon>
                        <div class="option-content">
                            <div class="option-title">Text Input</div>
                            <div class="option-desc">Free text entry for each variation</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dropdown Options Configuration -->
            <div *ngIf="selectedValueType === 'dropdown'" class="dropdown-config">
                <div class="form-group">
                    <label>Variation Options <span class="required">*</span></label>
                    <div class="options-container">
                        <div class="option-input-row" *ngFor="let option of variationOptions; let i = index">
                            <input type="text" 
                                   [(ngModel)]="option.value" 
                                   class="form-control option-input"
                                   [placeholder]="'Option ' + (i + 1)">
                            <button type="button" 
                                    class="remove-option-btn" 
                                    (click)="removeVariationOption(i)"
                                    [disabled]="variationOptions.length <= 1">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                        <button type="button" 
                                class="add-option-btn" 
                                (click)="addVariationOption()">
                            <mat-icon>add</mat-icon>
                            Add Option
                        </button>
                    </div>
                    <div *ngIf="selectedValueType === 'dropdown' && getValidOptions().length === 0" class="error-message">
                        At least one option is required
                    </div>
                </div>

                <!-- Quick Templates -->
                <div class="form-group">
                    <label>Quick Templates</label>
                    <div class="template-buttons">
                        <button type="button" class="template-btn" (click)="applyTemplate('size')">
                            Sizes (XS, S, M, L, XL)
                        </button>
                        <button type="button" class="template-btn" (click)="applyTemplate('color')">
                            Colors (Red, Blue, Green, Black, White)
                        </button>
                        <button type="button" class="template-btn" (click)="applyTemplate('material')">
                            Materials (Cotton, Polyester, Silk, Wool)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Text Input Configuration -->
            <div *ngIf="selectedValueType === 'text'" class="text-config">
                <div class="form-group">
                    <label>Input Configuration</label>
                    <div class="text-options">
                        <div class="checkbox-option">
                            <input type="checkbox" 
                                   id="required" 
                                   [(ngModel)]="textInputConfig.required">
                            <label for="required">Required field</label>
                        </div>
                        <div class="input-group">
                            <label>Placeholder Text <span class="required">*</span></label>
                            <input type="text" 
                                   [(ngModel)]="textInputConfig.placeholder" 
                                   class="form-control"
                                   placeholder="Enter placeholder text (e.g., Enter weight in kg)">
                            <div *ngIf="selectedValueType === 'text' && !textInputConfig.placeholder.trim()" class="error-message">
                                Placeholder text is required
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Value</label>
                            <input type="text" 
                                   [(ngModel)]="textInputConfig.value" 
                                   class="form-control"
                                   placeholder="Enter default value (optional)">
                            <small class="field-hint">Optional: Default value for this text input</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="variation-footer">
            <button type="button" 
                    class="btn btn-primary" 
                    (click)="saveProductVariation()"
                    [disabled]="!isVariationValid()">
                Create Variation
            </button>
            <button type="button" class="btn btn-outline" (click)="closeProductAvailability()">
                Cancel
            </button>
        </div>
    </div>
</div>

<div class="modal-backdrop" *ngIf="showSuccess">
    <div class="modal-success">
        <div class="modal-icon">
            <mat-icon>check_circle</mat-icon>
        </div>
        <div class="modal-message">
            <h2>Product has been successfully {{ isEditMode ? 'updated' : 'added' }}.</h2>
        </div>
        <div class="modal-actions">
            <button *ngIf="!isEditMode" class="btn btn-primary" (click)="addAnotherProduct()">Add Another Product</button>
            <button class="btn btn-outline" (click)="goToProductsList()">Go to Products List</button>
        </div>
    </div>
</div>