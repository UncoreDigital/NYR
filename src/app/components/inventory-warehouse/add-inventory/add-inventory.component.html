<div class="page-layout">
    <app-sidebar></app-sidebar>
    <div class="main-content">
        <app-header></app-header>
        <div class="content">

            <!-- Breadcrumb -->
            <div class="breadcrumb flex items-center space-x-2 text-gray-600">
                <!-- <a routerLink="/warehouse" class="breadcrumb-item hover:text-blue-600 cursor-pointer active">
                    Inventory
                </a>
                <mat-icon class="breadcrumb-separator text-gray-400">chevron_right</mat-icon> -->

                <a routerLink="/inwarehouse" class="breadcrumb-item hover:text-blue-600 cursor-pointer active">
                    Warehouse
                </a>
                <mat-icon class="breadcrumb-separator text-gray-400">chevron_right</mat-icon>

                <span class="breadcrumb-item text-gray-800 font-semibold active">
                    Add Inventory
                </span>
            </div>

            <!-- Page Header -->
            <div class="page-header">
                <h1>
                    Add Inventory
                    <mat-icon class="info-icon" matTooltip="Add Or Scan Products" matTooltipPosition="right">info</mat-icon>
                </h1>
            </div>

            <div class="table-container">
                <form [formGroup]="inventoryForm" class="user-form" (ngSubmit)="onSubmit()">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Warehouse</label>
                            <div class="custom-select-container">
                                <div class="search-wrapper">
                                    <mat-icon class="search-icon">search</mat-icon>
                                    <input type="text" 
                                           class="search-input" 
                                           [(ngModel)]="warehouseSearchTerm" 
                                           [ngModelOptions]="{standalone: true}"
                                           placeholder="Search and select warehouse..."
                                           (focus)="showWarehouseDropdown = true"
                                           (blur)="hideWarehouseDropdown()"
                                           (input)="filterWarehouses()"
                                           >
                                    <button type="button" 
                                            class="clear-button" 
                                            *ngIf="selectedWarehouse"
                                            (click)="clearWarehouse()"
                                            title="Clear selection">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showWarehouseDropdown && getFilteredWarehouses().length > 0">
                                    <div class="dropdown-item" 
                                         *ngFor="let warehouse of getFilteredWarehouses()"
                                         (mousedown)="selectWarehouse(warehouse)"
                                         [class.selected]="selectedWarehouse?.id === warehouse.id">
                                        {{warehouse.name}}
                                    </div>
                                </div>
                                <div class="dropdown-list" *ngIf="showWarehouseDropdown && getFilteredWarehouses().length === 0">
                                    <div class="dropdown-item no-results">No warehouses found</div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Select Product</label>
                            <div class="custom-select-container">
                                <div class="search-wrapper">
                                    <mat-icon class="search-icon">search</mat-icon>
                                    <input type="text" 
                                           class="search-input" 
                                           [(ngModel)]="productSearchTerm" 
                                           [ngModelOptions]="{standalone: true}"
                                           placeholder="Search and select product..."
                                           (focus)="showProductDropdown = true"
                                           (blur)="hideProductDropdown()"
                                           (input)="filterProducts()">
                                    <button type="button" 
                                            class="clear-button" 
                                            *ngIf="selectedProduct"
                                            (click)="clearProduct()"
                                            title="Clear selection">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showProductDropdown && getFilteredProducts().length > 0">
                                    <div class="dropdown-item" 
                                         *ngFor="let product of getFilteredProducts()"
                                         (mousedown)="selectProduct(product)"
                                         [class.selected]="selectedProduct?.id === product.id">
                                        {{product.name}}
                                    </div>
                                </div>
                                <div class="dropdown-list" *ngIf="showProductDropdown && getFilteredProducts().length === 0">
                                    <div class="dropdown-item no-results">
                                        No products found
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Warehouse Products List (Edit Mode Only) -->
                    <!-- <div class="warehouse-products-section" *ngIf="warehouseProducts.length > 0 && !selectedProduct">
                        <h3>Products in this Warehouse</h3>
                        <p class="section-description">Select a product to add more inventory</p>
                        <div class="products-grid">
                            <div class="product-card" 
                                 *ngFor="let product of warehouseProducts"
                                 (click)="selectProduct(product)">
                                <div class="product-card-content">
                                    <mat-icon class="product-icon">inventory_2</mat-icon>
                                    <div class="product-info">
                                        <h4>{{product.name}}</h4>
                                        <p class="product-sku" *ngIf="product.barcodeSKU">SKU: {{product.barcodeSKU}}</p>
                                    </div>
                                    <mat-icon class="arrow-icon">chevron_right</mat-icon>
                                </div>
                            </div>
                        </div>
                    </div> -->

                    <!-- Product Selection Message -->
                    <div class="variation-section" *ngIf="!selectedProduct">
                        <div class="no-product-message">
                            <mat-icon>info</mat-icon>
                            <p>Please select a product to view its variations.</p>
                        </div>
                    </div>

                    <!-- Variation Selection Section -->
                    <div class="variation-section" *ngIf="selectedProduct">
                        <!-- Combined Header with Scanner Icon and Search -->
                        <div class="section-header-combined" *ngIf="allVariants.length > 0">
                            <div class="search-container">
                                <mat-icon class="search-icon">search</mat-icon>
                                <input type="text" placeholder="Search variants..." class="search-input" 
                                       [(ngModel)]="searchTerm" [ngModelOptions]="{standalone: true}" 
                                       (keyup)="applyFilter($event)">
                            </div>
                            <div class="scanner-icon-container">
                                <mat-icon>qr_code_scanner</mat-icon>
                            </div>
                        </div>

                        <!-- No Variants Message -->
                        <div *ngIf="allVariants.length === 0" class="no-variations-message">
                            <mat-icon>info</mat-icon>
                            <p>This product has no variants available.</p>
                        </div>

                        <!-- Variant Table -->
                        <div class="variation-table-container" *ngIf="allVariants.length > 0">
                            <table class="variation-table">
                                <thead>
                                    <tr>
                                        <th>VARIANT NAME</th>
                                        <th>SKU</th>
                                        <th>CURRENT QTY</th>
                                        <th>QUANTITY</th>
                                        <th>ACTION</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let variant of filteredVariants; let i = index">
                                        <td>
                                            <div>{{variant.variantName}}</div>
                                            <div class="variant-attributes" *ngIf="variant.attributes && variant.attributes.length > 0">
                                                <span *ngFor="let attr of variant.attributes" class="attribute-badge">
                                                    {{attr.variationName}}: {{attr.variationOptionName}}
                                                </span>
                                            </div>
                                        </td>
                                        <td>{{variant.sku || '-'}}</td>
                                        <td>
                                            <span class="current-quantity">{{variant.currentQuantity || 0}}</span>
                                        </td>
                                        <td>
                                            <input type="number" 
                                                   class="variation-value-input" 
                                                   [(ngModel)]="variant.quantity" 
                                                   [ngModelOptions]="{standalone: true}"
                                                   placeholder="0"
                                                   min="0"
                                                   (input)="updateVariantQuantity(variant)">
                                        </td>
                                        <td>
                                            <button type="button" 
                                                    class="btn-add-variation" 
                                                    [class.btn-added]="isVariantInCart(variant)"
                                                    [disabled]="!variant.quantity || variant.quantity <= 0"
                                                    (click)="addVariantToCart(variant)">
                                                {{isVariantInCart(variant) ? 'Added' : 'Add'}}
                                            </button>
                                        </td>
                                    </tr>
                                    <tr *ngIf="filteredVariants.length === 0 && allVariants.length > 0" class="empty-row">
                                        <td [attr.colspan]="5">
                                            <mat-icon>search_off</mat-icon>
                                            <div>No variants found</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Universal Product (No Variants) -->
                        <div *ngIf="allVariants.length === 0" class="universal-product-section">
                            <div class="universal-product-form">
                                <div class="form-group">
                                    <label>Quantity</label>
                                    <input type="number" 
                                           class="quantity-input" 
                                           [(ngModel)]="universalProductQuantity" 
                                           [ngModelOptions]="{standalone: true}"
                                           placeholder="Enter quantity"
                                           min="0">
                                </div>
                                <button type="button" 
                                        class="btn-add-variation" 
                                        [disabled]="!universalProductQuantity || universalProductQuantity <= 0 || universalProductInCart"
                                        (click)="addUniversalProductToCart()">
                                    {{universalProductInCart ? 'Added' : 'Add to Cart'}}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Cart -->
                    <div class="inventory-cart-section" *ngIf="inventoryCart.length > 0">
                        <h4>Inventory to Add</h4>
                        <div class="cart-table-container">
                            <table class="cart-table">
                                <thead>
                                    <tr>
                                        <th>VARIANT</th>
                                        <th>QUANTITY</th>
                                        <th>ACTION</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let item of inventoryCart; let i = index">
                                        <td>
                                            <span *ngIf="item.variantName">
                                                {{item.variantName}}
                                            </span>
                                            <span *ngIf="!item.variantName">
                                                Universal Product
                                            </span>
                                        </td>
                                        <td>
                                            <input type="number" 
                                                   class="cart-quantity-input" 
                                                   [(ngModel)]="item.quantity" 
                                                   [ngModelOptions]="{standalone: true}"
                                                   min="1"
                                                   (input)="updateCartItemQuantity(i, item.quantity)">
                                        </td>
                                        <td>
                                            <button type="button" class="btn-remove" (click)="removeFromCart(i)">
                                                <mat-icon>delete</mat-icon>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" 
                                [disabled]="!selectedWarehouse || !selectedProduct || inventoryCart.length === 0">
                            Add Inventory
                        </button>
                        <button type="reset" class="btn btn-outline" (click)="onCancel()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>