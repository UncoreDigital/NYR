<div class="page-layout">
    <app-sidebar></app-sidebar>
    <div class="main-content">
        <app-header></app-header>
        <div class="content">

            <!-- Breadcrumb -->
            <div class="breadcrumb flex items-center space-x-2 text-gray-600">
                <!-- <a routerLink="/warehouse" class="breadcrumb-item hover:text-blue-600 cursor-pointer active">
                    Inventory
                </a>
                <mat-icon class="breadcrumb-separator text-gray-400">chevron_right</mat-icon> -->

                <a routerLink="/inwarehouse" class="breadcrumb-item hover:text-blue-600 cursor-pointer active">
                    Warehouse
                </a>
                <mat-icon class="breadcrumb-separator text-gray-400">chevron_right</mat-icon>

                <span class="breadcrumb-item text-gray-800 font-semibold active">
                    {{isEditMode ? 'Edit' : 'Add'}} Inventory
                </span>
            </div>

            <!-- Page Header -->
            <div class="page-header">
                <h1>{{isEditMode ? 'Edit' : 'Add'}} Inventory</h1>
            </div>

            <div class="table-container">
                <form [formGroup]="inventoryForm" class="user-form" (ngSubmit)="onSubmit()">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Warehouse <span *ngIf="isEditMode" style="color: #666; font-size: 12px;">(Locked)</span></label>
                            <div class="custom-select-container">
                                <div class="search-wrapper">
                                    <mat-icon class="search-icon" *ngIf="!isEditMode">search</mat-icon>
                                    <mat-icon class="search-icon" *ngIf="isEditMode">lock</mat-icon>
                                    <input type="text" 
                                           class="search-input" 
                                           [(ngModel)]="warehouseSearchTerm" 
                                           [ngModelOptions]="{standalone: true}"
                                           [placeholder]="isEditMode ? 'Warehouse (locked for editing)' : 'Search and select warehouse...'"
                                           (focus)="!isEditMode && (showWarehouseDropdown = true)"
                                           (blur)="hideWarehouseDropdown()"
                                           (input)="filterWarehouses()"
                                           [disabled]="isEditMode"
                                           [readonly]="isEditMode">
                                    <button type="button" 
                                            class="clear-button" 
                                            *ngIf="selectedWarehouse && !isEditMode"
                                            (click)="clearWarehouse()"
                                            title="Clear selection">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showWarehouseDropdown && !isEditMode && getFilteredWarehouses().length > 0">
                                    <div class="dropdown-item" 
                                         *ngFor="let warehouse of getFilteredWarehouses()"
                                         (mousedown)="selectWarehouse(warehouse)"
                                         [class.selected]="selectedWarehouse?.id === warehouse.id">
                                        {{warehouse.name}}
                                    </div>
                                </div>
                                <div class="dropdown-list" *ngIf="showWarehouseDropdown && !isEditMode && getFilteredWarehouses().length === 0">
                                    <div class="dropdown-item no-results">No warehouses found</div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Select Product 
                                <span *ngIf="isEditMode && warehouseProducts.length > 0" style="color: #1976d2; font-size: 12px;">
                                    ({{warehouseProducts.length}} product{{warehouseProducts.length > 1 ? 's' : ''}} in warehouse)
                                </span>
                            </label>
                            <div class="custom-select-container">
                                <div class="search-wrapper">
                                    <mat-icon class="search-icon">search</mat-icon>
                                    <input type="text" 
                                           class="search-input" 
                                           [(ngModel)]="productSearchTerm" 
                                           [ngModelOptions]="{standalone: true}"
                                           [placeholder]="isEditMode ? 'Search products in this warehouse...' : 'Search and select product...'"
                                           (focus)="showProductDropdown = true"
                                           (blur)="hideProductDropdown()"
                                           (input)="filterProducts()">
                                    <button type="button" 
                                            class="clear-button" 
                                            *ngIf="selectedProduct && !isEditMode"
                                            (click)="clearProduct()"
                                            title="Clear selection">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showProductDropdown && getFilteredProducts().length > 0">
                                    <div class="dropdown-item" 
                                         *ngFor="let product of getFilteredProducts()"
                                         (mousedown)="selectProduct(product)"
                                         [class.selected]="selectedProduct?.id === product.id">
                                        {{product.name}}
                                    </div>
                                </div>
                                <div class="dropdown-list" *ngIf="showProductDropdown && getFilteredProducts().length === 0">
                                    <div class="dropdown-item no-results">
                                        {{isEditMode ? 'No products found in this warehouse' : 'No products found'}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Warehouse Products List (Edit Mode Only) -->
                    <div class="warehouse-products-section" *ngIf="isEditMode && warehouseProducts.length > 0 && !selectedProduct">
                        <h3>Products in this Warehouse</h3>
                        <p class="section-description">Select a product to add more inventory</p>
                        <div class="products-grid">
                            <div class="product-card" 
                                 *ngFor="let product of warehouseProducts"
                                 (click)="selectProduct(product)">
                                <div class="product-card-content">
                                    <mat-icon class="product-icon">inventory_2</mat-icon>
                                    <div class="product-info">
                                        <h4>{{product.name}}</h4>
                                        <p class="product-sku" *ngIf="product.barcodeSKU">SKU: {{product.barcodeSKU}}</p>
                                    </div>
                                    <mat-icon class="arrow-icon">chevron_right</mat-icon>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Selection Message -->
                    <div class="variation-section" *ngIf="!selectedProduct && (!isEditMode || warehouseProducts.length === 0)">
                        <div class="no-product-message">
                            <mat-icon>info</mat-icon>
                            <p *ngIf="!isEditMode">Please select a product to view its variations.</p>
                            <p *ngIf="isEditMode && warehouseProducts.length === 0">
                                This warehouse has no products yet. Please go back and add inventory first.
                            </p>
                        </div>
                    </div>

                    <!-- Variation Selection Section -->
                    <div class="variation-section" *ngIf="selectedProduct">
                        <div class="section-header">
                            <h3>Product Variations</h3>
                            <button type="button" 
                                    class="btn-change-product" 
                                    *ngIf="isEditMode && warehouseProducts.length > 1"
                                    (click)="changeProduct()">
                                <mat-icon>swap_horiz</mat-icon>
                                Change Product
                            </button>
                        </div>
                        
                        <!-- Search Bar -->
                        <div class="search-container" *ngIf="allVariations.length > 0">
                            <mat-icon class="search-icon">search</mat-icon>
                            <input type="text" placeholder="Search variations..." class="search-input" 
                                   [(ngModel)]="searchTerm" [ngModelOptions]="{standalone: true}" 
                                   (keyup)="applyFilter($event)">
                        </div>

                        <!-- No Variations Message -->
                        <div *ngIf="allVariations.length === 0" class="no-variations-message">
                            <mat-icon>info</mat-icon>
                            <p>This product has no variations available.</p>
                        </div>

                        <!-- Variation Table -->
                        <div class="variation-table-container" *ngIf="allVariations.length > 0">
                            <table class="variation-table">
                                <thead>
                                    <tr>
                                        <th>VARIATION TYPE</th>
                                        <th>VARIATION VALUE</th>
                                        <th *ngIf="isEditMode">CURRENT QTY</th>
                                        <th>{{isEditMode ? 'ADD QUANTITY' : 'QUANTITY'}}</th>
                                        <th>ACTION</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let variation of filteredVariations; let i = index">
                                        <td>{{variation.name}}</td>
                                        <td>{{variation.value}}</td>
                                        <td *ngIf="isEditMode">
                                            <span class="current-quantity">{{variation.currentQuantity || 0}}</span>
                                        </td>
                                        <td>
                                            <input type="number" 
                                                   class="variation-value-input" 
                                                   [(ngModel)]="variation.quantity" 
                                                   [ngModelOptions]="{standalone: true}"
                                                   [placeholder]="isEditMode ? 'Add qty' : '0'"
                                                   min="0"
                                                   (input)="updateVariationQuantity(variation)">
                                        </td>
                                        <td>
                                            <button type="button" 
                                                    class="btn-add-variation" 
                                                    [class.btn-added]="isVariationInCart(variation)"
                                                    [disabled]="!variation.quantity || variation.quantity <= 0"
                                                    (click)="addVariationToCart(variation)">
                                                {{isVariationInCart(variation) ? 'Added' : 'Add'}}
                                            </button>
                                        </td>
                                    </tr>
                                    <tr *ngIf="filteredVariations.length === 0 && allVariations.length > 0" class="empty-row">
                                        <td [attr.colspan]="isEditMode ? 5 : 4">
                                            <mat-icon>search_off</mat-icon>
                                            <div>No variations found</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Universal Product (No Variations) -->
                        <div *ngIf="allVariations.length === 0" class="universal-product-section">
                            <div class="universal-product-form">
                                <div class="form-group">
                                    <label>Quantity</label>
                                    <input type="number" 
                                           class="quantity-input" 
                                           [(ngModel)]="universalProductQuantity" 
                                           [ngModelOptions]="{standalone: true}"
                                           placeholder="Enter quantity"
                                           min="0">
                                </div>
                                <button type="button" 
                                        class="btn-add-variation" 
                                        [disabled]="!universalProductQuantity || universalProductQuantity <= 0 || universalProductInCart"
                                        (click)="addUniversalProductToCart()">
                                    {{universalProductInCart ? 'Added' : 'Add to Cart'}}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Cart -->
                    <div class="inventory-cart-section" *ngIf="inventoryCart.length > 0">
                        <h4>{{isEditMode ? 'Inventory to Update' : 'Inventory to Add'}}</h4>
                        <div class="cart-table-container">
                            <table class="cart-table">
                                <thead>
                                    <tr>
                                        <th>VARIATION</th>
                                        <th>{{isEditMode ? 'QUANTITY TO ADD' : 'QUANTITY'}}</th>
                                        <th>ACTION</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let item of inventoryCart; let i = index">
                                        <td>
                                            <span *ngIf="item.variationName && item.variationValue">
                                                {{item.variationName}} - {{item.variationValue}}
                                            </span>
                                            <span *ngIf="!item.variationName">
                                                Universal Product
                                            </span>
                                        </td>
                                        <td>
                                            <input type="number" 
                                                   class="cart-quantity-input" 
                                                   [(ngModel)]="item.quantity" 
                                                   [ngModelOptions]="{standalone: true}"
                                                   min="1"
                                                   (input)="updateCartItemQuantity(i, item.quantity)">
                                        </td>
                                        <td>
                                            <button type="button" class="btn-remove" (click)="removeFromCart(i)">
                                                <mat-icon>delete</mat-icon>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" 
                                [disabled]="!selectedWarehouse || !selectedProduct || inventoryCart.length === 0">
                            {{isEditMode ? 'Update' : 'Add'}} Inventory
                        </button>
                        <button type="reset" class="btn btn-outline" (click)="onCancel()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>