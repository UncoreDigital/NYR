<div class="page-layout">
    <app-sidebar></app-sidebar>
    <div class="main-content">
        <app-header></app-header>
        <div class="content">

            <!-- Breadcrumb -->
            <div class="breadcrumb flex items-center space-x-2 text-gray-600">
                <!-- Breadcrumb when coming from Transfers -->
                <ng-container *ngIf="isFromTransfers">
                    <a routerLink="/transfers" class="breadcrumb-item hover:text-blue-600 cursor-pointer active">
                        Transfers
                    </a>
                    <mat-icon class="breadcrumb-separator text-gray-400">chevron_right</mat-icon>
                    <span class="breadcrumb-item text-gray-800 font-semibold active">
                        Transfer To Location
                    </span>
                </ng-container>

                <!-- Default breadcrumb when coming from Locations or other pages -->
                <ng-container *ngIf="!isFromTransfers">
                    <a routerLink="/inlocation" class="breadcrumb-item hover:text-blue-600 cursor-pointer active">
                        Locations
                    </a>
                    <mat-icon class="breadcrumb-separator text-gray-400">chevron_right</mat-icon>
                    <span class="breadcrumb-item text-gray-800 font-semibold active">
                        Transfer To Location
                    </span>
                </ng-container>
            </div>


            <!-- Page Header -->
            <div class="page-header">
                <h1>Transfer To Location</h1>

            </div>

            <div class="table-container">
                <form [formGroup]="vanForm" class="user-form" (ngSubmit)="onSubmit()">
                    <div class="form-row">
                        <div class="radio-group" style="margin-bottom: 20px;">
                            <label class="radio-option mr-15">
                                <input type="radio" name="transferType" value="manual"
                                    [(ngModel)]="selectedTransferOption" [ngModelOptions]="{standalone: true}"
                                    class="radio-input mr-2">
                                <span class="radio-label">Manual</span>
                            </label>
                            
                            <label class="radio-option mr-15">
                                <input type="radio" name="transferType" value="scan"
                                    [(ngModel)]="selectedTransferOption" [ngModelOptions]="{standalone: true}"
                                    class="radio-input mr-2">
                                <span class="radio-label">Scan</span>
                            </label>
                        </div>
                    </div>
 
                   <div class="form-row">
                        <div class="form-group">
                            <label>Select Customer</label>
                            <div class="custom-select-container">
                                <div class="search-wrapper">
                                    <mat-icon class="search-icon">search</mat-icon>
                                    <input type="text" 
                                           class="search-input" 
                                           [(ngModel)]="customerSearchTerm" 
                                           [ngModelOptions]="{standalone: true}"
                                           placeholder="Search and select customer..."
                                           (focus)="showCustomerDropdown = true"
                                           (blur)="hideCustomerDropdown()"
                                           (input)="filterCustomers()">
                                    <button type="button" 
                                            class="clear-button" 
                                            *ngIf="selectedCustomer"
                                            (click)="clearCustomer()"
                                            title="Clear selection">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showCustomerDropdown && isLoadingCustomers">
                                    <div class="dropdown-item no-results">Loading customers...</div>
                                </div>
                                <div class="dropdown-list" *ngIf="showCustomerDropdown && !isLoadingCustomers && getFilteredCustomers().length > 0">
                                    <div class="dropdown-item" 
                                         *ngFor="let customer of getFilteredCustomers()"
                                         (mousedown)="selectCustomer(customer)"
                                         [class.selected]="selectedCustomer?.value === customer.value">
                                        {{customer.name}}
                                    </div>
                                </div>
                                <div class="dropdown-list" *ngIf="showCustomerDropdown && !isLoadingCustomers && getFilteredCustomers().length === 0">
                                    <div class="dropdown-item no-results">No customers found</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Select Location</label>
                            <div class="custom-select-container">
                                <div class="search-wrapper">
                                    <mat-icon class="search-icon">search</mat-icon>
                                    <input type="text" 
                                           class="search-input" 
                                           [(ngModel)]="locationSearchTerm" 
                                           [ngModelOptions]="{standalone: true}"
                                           placeholder="Search and select location..."
                                           (focus)="showLocationDropdown = true"
                                           (blur)="hideLocationDropdown()"
                                           (input)="filterLocations()">
                                    <button type="button" 
                                            class="clear-button" 
                                            *ngIf="selectedLocation"
                                            (click)="clearLocation()"
                                            title="Clear selection">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showLocationDropdown && isLoadingLocations">
                                    <div class="dropdown-item no-results">Loading locations...</div>
                                </div>
                                <div class="dropdown-list" *ngIf="showLocationDropdown && !isLoadingLocations && getFilteredLocations().length > 0">
                                    <div class="dropdown-item" 
                                         *ngFor="let location of getFilteredLocations()"
                                         (mousedown)="selectLocation(location)"
                                         [class.selected]="selectedLocation?.value === location.value">
                                        {{location.name}}
                                    </div>
                                </div>
                                <div class="dropdown-list" *ngIf="showLocationDropdown && !isLoadingLocations && getFilteredLocations().length === 0">
                                    <div class="dropdown-item no-results">No locations found</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Select Warehouse</label>
                            <div class="custom-select-container">
                                <div class="search-wrapper">
                                    <mat-icon class="search-icon">search</mat-icon>
                                    <input type="text" 
                                           class="search-input" 
                                           [(ngModel)]="warehouseSearchTerm" 
                                           [ngModelOptions]="{standalone: true}"
                                           placeholder="Search and select warehouse..."
                                           (focus)="showWarehouseDropdown = true"
                                           (blur)="hideWarehouseDropdown()"
                                           (input)="filterWarehouses()"
                                           [disabled]="isLoadingWarehouses">
                                    <button type="button" 
                                            class="clear-button" 
                                            *ngIf="selectedWarehouse"
                                            (click)="clearWarehouse()"
                                            title="Clear selection">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showWarehouseDropdown && isLoadingWarehouses">
                                    <div class="dropdown-item no-results">Loading warehouses...</div>
                                </div>
                                <div class="dropdown-list" *ngIf="showWarehouseDropdown && !isLoadingWarehouses && getFilteredWarehouses().length > 0">
                                    <div class="dropdown-item" 
                                         *ngFor="let warehouse of getFilteredWarehouses()"
                                         (mousedown)="selectWarehouse(warehouse)"
                                         [class.selected]="selectedWarehouse?.value === warehouse.value">
                                        {{warehouse.name}}
                                    </div>
                                </div>
                                <div class="dropdown-list" *ngIf="showWarehouseDropdown && !isLoadingWarehouses && getFilteredWarehouses().length === 0">
                                    <div class="dropdown-item no-results">No warehouses found</div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Product</label>
                            <div class="custom-select-container">
                                <div class="search-wrapper">
                                    <mat-icon class="search-icon">search</mat-icon>
                                    <input type="text" 
                                           class="search-input" 
                                           [(ngModel)]="productSearchTerm" 
                                           [ngModelOptions]="{standalone: true}"
                                           placeholder="Search and select product..."
                                           (focus)="showProductDropdown = true"
                                           (blur)="hideProductDropdown()"
                                           (input)="filterProducts()"
                                           [disabled]="isLoadingInventory || !selectedWarehouse">
                                    <button type="button" 
                                            class="clear-button" 
                                            *ngIf="selectedProduct"
                                            (click)="clearProduct()"
                                            title="Clear selection">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showProductDropdown && isLoadingInventory">
                                    <div class="dropdown-item no-results">Loading products...</div>
                                </div>
                                <div class="dropdown-list" *ngIf="showProductDropdown && !isLoadingInventory && getFilteredProducts().length > 0">
                                    <div class="dropdown-item" 
                                         *ngFor="let product of getFilteredProducts()"
                                         (mousedown)="selectProduct(product)"
                                         [class.selected]="selectedProduct?.value === product.value">
                                        {{product.name}}
                                    </div>
                                </div>
                                <div class="dropdown-list" *ngIf="showProductDropdown && !isLoadingInventory && getFilteredProducts().length === 0">
                                    <div class="dropdown-item no-results">
                                        {{selectedWarehouse ? 'No products found in this warehouse' : 'Please select a warehouse first'}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Scan Mode Section -->
                    <div class="scan-section" *ngIf="selectedTransferOption === 'scan'">
                        <div class="no-product-message">
                            <mat-icon>qr_code_scanner</mat-icon>
                            <p>Scan functionality will be implemented here.</p>
                            <p style="font-size: 14px; color: #999; margin-top: 8px;">Please use Manual mode for now.</p>
                        </div>
                    </div>

                    <!-- Product Variations Section (Manual Mode) -->
                    <div class="variation-section" *ngIf="selectedTransferOption === 'manual' && selectedProduct && allVariations.length > 0">
                        <h3>Product Variations - Available in Warehouse</h3>
                        
                        <!-- Search Bar -->
                        <div class="search-container">
                            <mat-icon class="search-icon">search</mat-icon>
                            <input type="text" placeholder="Search variations..." class="search-input" 
                                   [(ngModel)]="variationSearchTerm" [ngModelOptions]="{standalone: true}" 
                                   (keyup)="applyVariationFilter($event)">
                        </div>

                        <!-- Variation Table -->
                        <div class="variation-table-container">
                            <table class="variation-table">
                                <thead>
                                    <tr>
                                        <th>VARIATION TYPE</th>
                                        <th>VARIATION VALUE</th>
                                        <th>AVAILABLE QTY</th>
                                        <th>TRANSFER QTY</th>
                                        <th>ACTION</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let variation of filteredVariations">
                                        <td>{{variation.variationType}}</td>
                                        <td>{{variation.variationValue}}</td>
                                        <td><span class="available-quantity">{{variation.availableQuantity}}</span></td>
                                        <td>
                                            <input type="number" 
                                                   class="variation-value-input" 
                                                   [(ngModel)]="variation.transferQuantity" 
                                                   [ngModelOptions]="{standalone: true}"
                                                   placeholder="0"
                                                   min="0"
                                                   [max]="variation.availableQuantity">
                                        </td>
                                        <td>
                                            <button type="button" 
                                                    class="btn-add-variation" 
                                                    [class.btn-added]="isVariationInCart(variation)"
                                                    [disabled]="!variation.transferQuantity || variation.transferQuantity <= 0 || variation.transferQuantity > variation.availableQuantity"
                                                    (click)="addVariationToCart(variation)">
                                                {{isVariationInCart(variation) ? 'Added' : 'Add'}}
                                            </button>
                                        </td>
                                    </tr>
                                    <tr *ngIf="filteredVariations.length === 0" class="empty-row">
                                        <td colspan="5">
                                            <mat-icon>search_off</mat-icon>
                                            <div>No variations found</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- No Variations Message (Manual Mode) -->
                    <div class="no-product-message" *ngIf="selectedTransferOption === 'manual' && selectedProduct && allVariations.length === 0">
                        <mat-icon>info</mat-icon>
                        <p>No inventory available for this product in the selected warehouse.</p>
                    </div>

                    <!-- Transfer Cart -->
                    <div class="inventory-cart-section" *ngIf="transferCart.length > 0">
                        <h4>Transfer Cart</h4>
                        <div class="cart-table-container">
                            <table class="cart-table">
                                <thead>
                                    <tr>
                                        <th>PRODUCT</th>
                                        <th>VARIATION</th>
                                        <th>AVAILABLE</th>
                                        <th>QUANTITY</th>
                                        <th>ACTION</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let item of transferCart; let i = index">
                                        <td>{{item.productName}}</td>
                                        <td>{{item.variationType}} - {{item.variationValue}}</td>
                                        <td><span class="available-quantity">{{item.availableQuantity}}</span></td>
                                        <td>
                                            <input type="number" 
                                                   class="cart-quantity-input" 
                                                   [(ngModel)]="item.quantity" 
                                                   [ngModelOptions]="{standalone: true}"
                                                   min="1"
                                                   [max]="item.availableQuantity"
                                                   (input)="updateCartItemQuantity(i, item.quantity)">
                                        </td>
                                        <td>
                                            <button type="button" class="btn-remove" (click)="removeFromTransferCart(i)">
                                                <mat-icon>delete</mat-icon>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="form-actions" style="justify-content: flex-end;">
                        <button type="reset" class="btn btn-outline" [disabled]="isSaving" (click)="onCancel()">Cancel</button>
                        <button type="submit" class="btn btn-primary" 
                                [disabled]="isSaving || transferCart.length === 0 || selectedTransferOption === 'scan'">
                            <mat-spinner *ngIf="isSaving" diameter="16" style="display: inline-block; margin-right: 8px;"></mat-spinner>
                            {{ isSaving ? 'Saving...' : 'Save Transfer' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Removed scan popup section as we're focusing on manual transfer -->