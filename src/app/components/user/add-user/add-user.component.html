<div class="page-layout">
    <app-sidebar></app-sidebar>
    <div class="main-content">
        <app-header></app-header>
        <div class="content">

            <!-- Breadcrumb -->
            <div class="breadcrumb flex items-center space-x-2 text-gray-600">
                <!-- <a routerLink="/users" class="breadcrumb-item hover:text-blue-600 cursor-pointer active">
                    Settings
                </a>
                <mat-icon class="breadcrumb-separator text-gray-400">chevron_right</mat-icon> -->

                <a routerLink="/users" class="breadcrumb-item hover:text-blue-600 cursor-pointer active">
                    User
                </a>
                <mat-icon class="breadcrumb-separator text-gray-400">chevron_right</mat-icon>

                <span class="breadcrumb-item text-gray-800 font-semibold active">
                    {{ isEditMode ? 'Edit User' : 'Add User' }}
                </span>
            </div>


            <!-- Page Header -->
            <div class="page-header">
                <h1>{{ isEditMode ? 'Edit User' : 'Add User' }}</h1>

            </div>


            <!-- Loading Spinner for Data -->
            <div *ngIf="isLoading" class="loading-container">
                <mat-spinner diameter="50"></mat-spinner>
                <p>Loading data...</p>
            </div>

            <div class="table-container" *ngIf="!isLoading">
                <form [formGroup]="userForm" class="user-form" (ngSubmit)="onSubmit()">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Role</label>
                            <div class="custom-select-container">
                                <div class="search-wrapper" (click)="showRoleDropdown = true">
                                    <mat-icon class="search-icon">search</mat-icon>
                                    <input 
                                        type="text" 
                                        class="search-input" 
                                        placeholder="Select a role"
                                        [value]="roleSearchTerm"
                                        (input)="onRoleSearchInput($event); filterRoles()"
                                        (focus)="showRoleDropdown = true"
                                        (blur)="hideRoleDropdown()"
                                        [readonly]="selectedRole ? true : false"
                                    >
                                    <button 
                                        *ngIf="selectedRole" 
                                        type="button" 
                                        class="clear-button"
                                        (click)="clearRole(); $event.stopPropagation()"
                                    >
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showRoleDropdown && !selectedRole">
                                    <div 
                                        class="dropdown-item" 
                                        *ngFor="let role of getFilteredRoles()"
                                        (mousedown)="selectRole(role)"
                                        [class.selected]="selectedRole?.id === role.id"
                                    >
                                        {{ role.name }}
                                    </div>
                                    <div *ngIf="getFilteredRoles().length === 0" class="no-results">
                                        No roles found
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group"
                            *ngIf="userForm.get('roleId')?.value == '' || userForm.get('roleId')?.value == 1 || userForm.get('roleId')?.value == 3">
                            <label>Customer</label>
                            <div class="custom-select-container">
                                <div class="search-wrapper" (click)="showCustomerDropdown = true">
                                    <mat-icon class="search-icon">search</mat-icon>
                                    <input 
                                        type="text" 
                                        class="search-input" 
                                        placeholder="Select a Customer"
                                        [value]="customerSearchTerm"
                                        (input)="onCustomerSearchInput($event); filterCustomers()"
                                        (focus)="showCustomerDropdown = true"
                                        (blur)="hideCustomerDropdown()"
                                        [readonly]="selectedCustomer ? true : false"
                                    >
                                    <button 
                                        *ngIf="selectedCustomer" 
                                        type="button" 
                                        class="clear-button"
                                        (click)="clearCustomer(); $event.stopPropagation()"
                                    >
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showCustomerDropdown && !selectedCustomer">
                                    <div 
                                        class="dropdown-item" 
                                        *ngFor="let customer of getFilteredCustomers()"
                                        (mousedown)="selectCustomer(customer)"
                                        [class.selected]="selectedCustomer?.id === customer.id"
                                    >
                                        {{ customer.companyName }}
                                    </div>
                                    <div *ngIf="getFilteredCustomers().length === 0" class="no-results">
                                        No customers found
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group"
                            *ngIf="userForm.get('roleId')?.value == '' || userForm.get('roleId')?.value == 1 || userForm.get('roleId')?.value == 3">
                            <label>Select Location</label>
                            <div class="custom-select-container" *ngIf="!isLoadingLocations">
                                <div class="search-wrapper" 
                                     (click)="userForm.get('customerId')?.value ? showLocationDropdown = true : null"
                                     [class.disabled]="!userForm.get('customerId')?.value">
                                     <mat-icon class="search-icon">search</mat-icon>
                                     <input 
                                        type="text" 
                                        class="search-input" 
                                        [placeholder]="!userForm.get('customerId')?.value ? 'Select Customer first' : 
                                                     locations.length === 0 ? 'No locations available' : 'Select a Location'"
                                        [value]="locationSearchTerm"
                                        (input)="onLocationSearchInput($event); filterLocations()"
                                        (focus)="userForm.get('customerId')?.value ? showLocationDropdown = true : null"
                                        (blur)="hideLocationDropdown()"
                                        [readonly]="selectedLocation ? true : false"
                                        [disabled]="!userForm.get('customerId')?.value"
                                    >
                                    <button 
                                        *ngIf="selectedLocation" 
                                        type="button" 
                                        class="clear-button"
                                        (click)="clearLocation(); $event.stopPropagation()"
                                    >
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showLocationDropdown && !selectedLocation && locations.length > 0">
                                    <div 
                                        class="dropdown-item" 
                                        *ngFor="let location of getFilteredLocations()"
                                        (mousedown)="selectLocation(location)"
                                        [class.selected]="selectedLocation?.id === location.id"
                                    >
                                        {{ location.locationName }}
                                    </div>
                                    <div *ngIf="getFilteredLocations().length === 0" class="no-results">
                                        No locations found
                                    </div>
                                </div>
                            </div>
                            <div *ngIf="isLoadingLocations" class="loading-container">
                                <span class="loading-text">Loading locations...</span>
                            </div>
                        </div>
                        <div class="form-group" *ngIf="userForm.get('roleId')?.value == 4">
                            <label>&nbsp;</label>
                            <button type="button" 
                                    class="btn btn-primary" 
                                    style="width: fit-content;" 
                                    (click)="driverAvailabilityClick()"
                                    [disabled]="(pendingDriverAvailabilities.length + (isEditMode ? existingDriverAvailabilities.length : 0)) >= 10">
                                Manage Driver Availability
                                <span *ngIf="(pendingDriverAvailabilities.length + (isEditMode ? existingDriverAvailabilities.length : 0)) >= 10" 
                                      style="margin-left: 8px; font-size: 0.8em; color: #ff6b6b;">(Limit Reached)</span>
                            </button>
                        </div>
                    </div>

                    <!-- Display existing driver availability chips (Edit Mode) -->
                    <div *ngIf="userForm.get('roleId')?.value == 4 && isEditMode && existingDriverAvailabilities.length > 0" class="form-row">
                        <div class="form-group" style="width: 100%;">
                            <label>Current Driver Availability 
                                <span style="font-size: 0.8em; color: #666; font-weight: normal;">
                                    ({{ existingDriverAvailabilities.length }}/10)
                                </span>
                            </label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                                <div *ngFor="let availability of existingDriverAvailabilities; let i = index" 
                                     style="display: flex; align-items: center; background-color: #A0EBE5; color: #08504B; 
                                            border: 1px solid #08504B; padding: 6px 12px; border-radius: 16px; font-size: 0.9rem;">
                                    <span>{{ getExistingAvailabilityText(availability) }}</span>
                                    <button type="button" 
                                            style="background: none; border: none; color: #08504B; margin-left: 8px; cursor: pointer; 
                                                   padding: 2px; border-radius: 50%; width: 20px; height: 20px; display: flex; 
                                                   align-items: center; justify-content: center;"
                                            (click)="removeExistingAvailability(i)"
                                            title="Remove availability">
                                        <mat-icon style="font-size: 16px;">close</mat-icon>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Display pending driver availability chips (New User Mode) -->
                    <div *ngIf="userForm.get('roleId')?.value == 4 && !isEditMode && pendingDriverAvailabilities.length > 0" class="form-row">
                        <div class="form-group" style="width: 100%;">
                            <label>Driver Availability 
                                <span style="font-size: 0.8em; color: #666; font-weight: normal;">
                                    ({{ pendingDriverAvailabilities.length }}/10)
                                </span>
                            </label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                                <div *ngFor="let availability of pendingDriverAvailabilities; let i = index" 
                                     style="display: flex; align-items: center; background-color: #A0EBE5; color: #08504B; 
                                            border: 1px solid #08504B; padding: 6px 12px; border-radius: 16px; font-size: 0.9rem;">
                                    <span>{{ getSelectedDaysText(availability) }}</span>
                                    <button type="button" 
                                            style="background: none; border: none; color: #08504B; margin-left: 8px; cursor: pointer; 
                                                   padding: 2px; border-radius: 50%; width: 20px; height: 20px; display: flex; 
                                                   align-items: center; justify-content: center;"
                                            (click)="removePendingAvailability(i)"
                                            title="Remove availability">
                                        <mat-icon style="font-size: 16px;">close</mat-icon>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Name*</label>
                            <input formControlName="name" type="text" placeholder="Enter Name" />
                        </div>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input formControlName="email" type="text" placeholder="Enter Email Address" />
                        </div>
                        <div class="form-group">
                            <label>Phone Number*</label>
                            <input formControlName="phoneNumber" type="tel" inputmode="numeric" maxlength="10" pattern="\d{10}" placeholder="Enter Phone Number" (input)="onPhoneInput('phoneNumber', $event)" />
                        </div>
                        <div class="form-group">
                            <label>Password{{ isEditMode ? ' (Optional)' : '' }}</label>
                            <input formControlName="password" type="password" 
                                   [placeholder]="isEditMode ? 'Enter new password (leave blank to keep current)' : 'Enter Password'" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Address Line 1</label>
                            <input formControlName="addressLine1" type="text" placeholder="Enter Address Line 1" />
                        </div>
                        <div class="form-group">
                            <label>Address Line 2</label>
                            <input formControlName="addressLine2" type="text" placeholder="Enter Address Line 2" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>City</label>
                            <input formControlName="city" type="text" placeholder="Enter City" />
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input formControlName="state" type="text" placeholder="Enter State" />
                        </div>
                        <div class="form-group">
                            <label>Zip Code</label>
                            <input formControlName="zipCode" type="text" inputmode="numeric" maxlength="10" pattern="\d+" placeholder="Enter Zip" (input)="onDigitsInput('zipCode', $event)" />
                        </div>
                    </div>
                    <div class="form-row" *ngIf="userForm.get('roleId')?.value == 4">
                        <!-- <div class="form-group">
                            <label>Home Address</label>
                            <input formControlName="homeAddress" type="text" placeholder="Enter Home Address" />
                        </div> -->
                        <div class="form-group">
                            <label>Default Starting Point</label>
                            <div class="custom-select-container" *ngIf="!isLoadingWarehouses">
                                <div class="search-wrapper" (click)="showStartingPointDropdown = true">
                                    <mat-icon class="search-icon">search</mat-icon>
                                    <input 
                                        type="text" 
                                        class="search-input" 
                                        placeholder="Select starting point"
                                        [value]="startingPointSearchTerm"
                                        (input)="onStartingPointSearchInput($event); filterStartingPoints()"
                                        (focus)="showStartingPointDropdown = true"
                                        (blur)="hideStartingPointDropdown()"
                                        [readonly]="selectedStartingPoint ? true : false"
                                    >
                                    <button 
                                        *ngIf="selectedStartingPoint" 
                                        type="button" 
                                        class="clear-button"
                                        (click)="clearStartingPoint(); $event.stopPropagation()"
                                    >
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showStartingPointDropdown && !selectedStartingPoint">
                                    <div 
                                        class="dropdown-item" 
                                        *ngFor="let option of getFilteredStartingPoints()"
                                        (mousedown)="selectStartingPoint(option)"
                                        [class.selected]="selectedStartingPoint?.id === option.id"
                                    >
                                        <div class="dropdown-item-content">
                                            <span class="option-name">{{ option.name }}</span>
                                            <span class="option-type" [class.home-type]="option.type === 'home'" [class.warehouse-type]="option.type === 'warehouse'">
                                                {{ option.type === 'home' ? 'Home' : 'Warehouse' }}
                                            </span>
                                        </div>
                                    </div>
                                    <div *ngIf="getFilteredStartingPoints().length === 0" class="no-results">
                                        No starting points found
                                    </div>
                                </div>
                            </div>
                            <div *ngIf="isLoadingWarehouses" class="loading-container">
                                <span class="loading-text">Loading starting points...</span>
                            </div>
                        </div>
                        <div class="form-group"></div>
                        <div class="form-group"></div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" [disabled]="isSaving">
                            <mat-spinner *ngIf="isSaving" diameter="20" class="inline-spinner"></mat-spinner>
                            <span *ngIf="!isSaving">Save</span>
                            <span *ngIf="isSaving">Saving...</span>
                        </button>
                        <button type="button" class="btn btn-outline" [disabled]="isSaving" (click)="onCancel()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal-backdrop" id="driverAvailability" *ngIf="driverAvailability">
    <div class="modal-success">
        <h2 style="text-align:center; font-size:1.2rem; font-weight:600; margin-bottom:24px;">
            {{ isEditMode ? 'Manage Driver Availability' : 'Add Driver Availability' }}
        </h2>
        
        <div class="availability-days" style="display:flex; gap:18px; justify-content:center; margin-bottom:24px;">
            <label *ngFor="let day of days" style="display:flex; align-items:center; gap:6px; font-size:0.9rem;">
                <input type="checkbox" [(ngModel)]="driverDays[day]" />
                {{ day }}
            </label>
        </div>
        <div class="availability-times" style="display:flex; gap:24px; justify-content:center; margin-bottom:32px;">
            <div style="flex:1;">
                <label style="font-weight:400; display:block; margin-bottom:8px; text-align: left;">Start Time</label>
                <div style="position:relative;">
                    <input type="time" [(ngModel)]="startTime" placeholder="Select Time" />
                    <!-- <mat-icon
                        style="position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#bdbdbd;">schedule</mat-icon> -->
                </div>
            </div>
            <div style="flex:1;">
                <label style="font-weight:400; display:block; margin-bottom:8px; text-align: left;">End Time</label>
                <div style="position:relative;">
                    <input type="time" [(ngModel)]="endTime" placeholder="Select Time" />
                    <!-- <mat-icon
                        style="position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#bdbdbd;">schedule</mat-icon> -->
                </div>
            </div>
        </div>
        <div style="display:flex; gap:18px; justify-content:center;">
            <button class="btn btn-primary" (click)="saveDriverAvailability()">
                {{ isEditMode ? 'Add New Availability' : 'Add Availability' }}
            </button>
            <button class="btn btn-outline" (click)="closeDriverAvailability()">Cancel</button>
        </div>
    </div>
</div>
<div class="modal-backdrop" *ngIf="showSuccess">
    <div class="modal-success">
        <div class="modal-icon">
            <mat-icon>check_circle</mat-icon>
        </div>
        <div class="modal-message">
            <h2>User has been successfully {{ isEditMode ? 'updated' : 'added' }}.</h2>
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" (click)="addAnotherUser()" *ngIf="!isEditMode">Add Another User</button>
            <button class="btn btn-outline" (click)="goToUsersList()">Go to Users List</button>
        </div>
    </div>
</div>