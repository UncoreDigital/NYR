<div class="page-layout">
    <app-sidebar></app-sidebar>
    <div class="main-content">
        <app-header></app-header>
        <div class="content">

            <!-- Breadcrumb -->
            <div class="breadcrumb flex items-center space-x-2 text-gray-600">
                <a class="breadcrumb-item hover:text-blue-600 cursor-pointer active">
                    Settings
                </a>
                <mat-icon class="breadcrumb-separator text-gray-400">chevron_right</mat-icon>

                <a routerLink="/users" class="breadcrumb-item hover:text-blue-600 cursor-pointer active">
                    User
                </a>
                <mat-icon class="breadcrumb-separator text-gray-400">chevron_right</mat-icon>

                <span class="breadcrumb-item text-gray-800 font-semibold active">
                    {{ isEditMode ? 'Edit User' : 'Add User' }}
                </span>
            </div>


            <!-- Page Header -->
            <div class="page-header">
                <h1>{{ isEditMode ? 'Edit User' : 'Add User' }}</h1>

            </div>


            <!-- Loading Spinner for Data -->
            <div *ngIf="isLoading" class="loading-container">
                <mat-spinner diameter="50"></mat-spinner>
                <p>Loading data...</p>
            </div>

            <div class="table-container" *ngIf="!isLoading">
                <form [formGroup]="userForm" class="user-form" (ngSubmit)="onSubmit()">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Role</label>
                            <select formControlName="roleId" class="form-control">
                                <option value="" disabled selected>Select a role</option>
                                <option *ngFor="let role of roles" [value]="role.id">{{ role.name }}</option>
                            </select>
                        </div>
                        <div class="form-group"
                            *ngIf="userForm.get('roleId')?.value == '' || userForm.get('roleId')?.value == 1 || userForm.get('roleId')?.value == 4">
                            <label>Customer</label>
                            <select formControlName="customerId" class="form-control" (change)="onCustomerChange()">
                                <option value="" disabled selected>Select a Customer</option>
                                <option *ngFor="let customer of customers" [value]="customer.id">{{ customer.companyName }}</option>
                            </select>
                        </div>
                        <div class="form-group"
                            *ngIf="userForm.get('roleId')?.value == '' || userForm.get('roleId')?.value == 1 || userForm.get('roleId')?.value == 4">
                            <label>Select Location</label>
                            <select formControlName="locationId" class="form-control" [disabled]="!userForm.get('customerId')?.value || isLoadingLocations">
                                <option value="" disabled selected>
                                    {{ !userForm.get('customerId')?.value ? 'Select Customer first' : 
                                       isLoadingLocations ? 'Loading locations...' :
                                       locations.length === 0 ? 'No locations available' : 'Select a Location' }}
                                </option>
                                <option *ngFor="let location of locations" [value]="location.id">{{ location.locationName }}</option>
                            </select>
                        </div>
                        <div class="form-group" *ngIf="userForm.get('roleId')?.value == 3">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-primary" style="width: fit-content;" (click)="driverAvailabilityClick()">Manage Driver
                                Availability</button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Name</label>
                            <input formControlName="name" type="text" placeholder="Enter Name" />
                        </div>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input formControlName="email" type="text" placeholder="Enter Email Address" />
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input formControlName="phoneNumber" type="text" placeholder="Enter Phone Number" />
                        </div>
                        <div class="form-group">
                            <label>Password{{ isEditMode ? ' (Optional)' : '' }}</label>
                            <input formControlName="password" type="password" 
                                   [placeholder]="isEditMode ? 'Enter new password (leave blank to keep current)' : 'Enter Password'" />
                        </div>
                    </div>
                    <div class="form-row" *ngIf="userForm.get('roleId')?.value == 3">
                        <div class="form-group">
                            <label>Home Address</label>
                            <input formControlName="homeAddress" type="text" placeholder="Enter Home Address" />
                        </div>
                        <div class="form-group">
                            <label>Default Starting Point</label>
                            <input formControlName="startingPoint" type="text"
                                placeholder="Enter Default Starting Point" />
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" [disabled]="isSaving">
                            <mat-spinner *ngIf="isSaving" diameter="20" class="inline-spinner"></mat-spinner>
                            <span *ngIf="!isSaving">Save</span>
                            <span *ngIf="isSaving">Saving...</span>
                        </button>
                        <button type="reset" class="btn btn-outline" [disabled]="isSaving">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal-backdrop" id="driverAvailability" *ngIf="driverAvailability">
    <div class="modal-success">
        <h2 style="text-align:center; font-size:1.2rem; font-weight:600; margin-bottom:24px;">Manage Driver availability
        </h2>
        <div class="availability-days" style="display:flex; gap:18px; justify-content:center; margin-bottom:24px;">
            <label *ngFor="let day of days" style="display:flex; align-items:center; gap:6px; font-size:0.9rem;">
                <input type="checkbox" [(ngModel)]="driverDays[day]" />
                {{ day }}
            </label>
        </div>
        <div class="availability-times" style="display:flex; gap:24px; justify-content:center; margin-bottom:32px;">
            <div style="flex:1;">
                <label style="font-weight:400; display:block; margin-bottom:8px; text-align: left;">Start Time</label>
                <div style="position:relative;">
                    <input type="time" [(ngModel)]="startTime" placeholder="Select Time" />
                    <!-- <mat-icon
                        style="position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#bdbdbd;">schedule</mat-icon> -->
                </div>
            </div>
            <div style="flex:1;">
                <label style="font-weight:400; display:block; margin-bottom:8px; text-align: left;">End Time</label>
                <div style="position:relative;">
                    <input type="time" [(ngModel)]="endTime" placeholder="Select Time" />
                    <!-- <mat-icon
                        style="position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#bdbdbd;">schedule</mat-icon> -->
                </div>
            </div>
        </div>
        <div style="display:flex; gap:18px; justify-content:center;">
            <button class="btn btn-primary" (click)="saveDriverAvailability()">Done</button>
            <button class="btn btn-outline" (click)="closeDriverAvailability()">Cancel</button>
        </div>
    </div>
</div>
<div class="modal-backdrop" *ngIf="showSuccess">
    <div class="modal-success">
        <div class="modal-icon">
            <mat-icon>check_circle</mat-icon>
        </div>
        <div class="modal-message">
            <h2>User has been successfully {{ isEditMode ? 'updated' : 'added' }}.</h2>
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" (click)="addAnotherUser()" *ngIf="!isEditMode">Add Another User</button>
            <button class="btn btn-outline" (click)="goToUsersList()">Go to Users List</button>
        </div>
    </div>
</div>