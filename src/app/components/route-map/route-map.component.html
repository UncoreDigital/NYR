<!-- Full page layout when used as a standalone page -->
<div class="page-layout" *ngIf="showFullLayout">
    <app-sidebar></app-sidebar>
    <div class="main-content">
        <app-header></app-header>
        <div class="content">
            <!-- Breadcrumb -->
             <div class="breadcrumb flex items-center space-x-2 text-gray-600">
                <a routerLink="/routes" class="breadcrumb-item hover:text-blue-600 cursor-pointer active">
                    Routes
                </a>
                <mat-icon class="breadcrumb-separator text-gray-400">chevron_right</mat-icon>

                <a class="breadcrumb-item hover:text-blue-600 cursor-pointer active">
                    {{routeData?.driverName}}
                </a>
            </div>

            <!-- Route Header -->
            <div class="route-header">
                <div class="route-title">
                    <h1>Route A | {{ routeData?.driverName }}</h1>
                </div>
                <div class="route-actions">
                    <button class="btn btn-outline" (click)="goBack()">
                        Back to Routes
                    </button>
                </div>
            </div>
            <!-- Loader -->
            <div *ngIf="isLoading" class="loading-container">
                <mat-spinner diameter="50"></mat-spinner>
            </div>
            <!-- Route Content -->
            <div class="route-content">
                <ng-container *ngTemplateOutlet="mapContent"></ng-container>
            </div>
        </div>
    </div>
</div>

<!-- Component-only layout when used within other components -->
<div class="route-content" *ngIf="!showFullLayout">
    <ng-container *ngTemplateOutlet="mapContent"></ng-container>
</div>

<!-- Map Content Template -->
<ng-template #mapContent>
                <!-- Map Section -->
                <div class="map-section">
                    <div class="map-container">
                        <!-- Map container (Google Maps JS API will render here) -->
                        <div id="map" #mapContainer style="height: 600px; width: 100%;"></div>

                        <!-- Error banner shown when DirectionsService fails -->
                        <div *ngIf="directionsError" class="map-error-banner">
                            <div class="map-error-message">{{ directionsError }}</div>
                            <div class="map-error-actions">
                                <button class="btn btn-sm btn-outline" (click)="retryDirections()">Retry</button>
                                <button class="btn btn-sm" (click)="clearDirectionsError()">Dismiss</button>
                            </div>
                        </div>

                        <!-- <div class="map-overlay">
                            <div class="route-progress">
                                <div class="progress-item">
                                    <mat-icon>schedule</mat-icon>
                                    <span>{{ getTotalTime() }}</span>
                                </div>
                                <div class="progress-item">
                                    <mat-icon>straighten</mat-icon>
                                    <span>{{ routeData?.distance || '5.1 miles' }}</span>
                                </div>
                            </div>
                        </div> -->
                    </div>
                </div>

                <!-- Route Details Section -->
                <div class="details-section">
                    <!-- Stops List -->
                    <div class="stops-section">
                        <h3>Route Stops</h3>
                        <div class="stops-list">
                            <div class="stop-item" 
                                 *ngFor="let stop of routeStops; let i = index"
                                 [class.completed]="!isDraftRoute ? stop.status.toLowerCase() === 'delivered' : false"
                                 [class.in-transit]="!isDraftRoute ? (stop.status === 'in-progress' || stop.status === 'In Progress') : false"
                                 [class.pending]="!isDraftRoute ? stop.status.toLowerCase() === 'pending' : false"
                                 [class.not-delivered]="!isDraftRoute ? (stop.status === 'not-delivered' || stop.status === 'Not Delivered') : false">
                                <div class="stop-header">
                                    <div style="color: #02c3b4; font-weight: 500;">
                                        <span>Stop {{ i + 1 }}</span>
                                    </div>
                                    <div class="stop-actions">
                                        <!-- Status only shown for non-draft routes -->
                                        <div class="stop-status" *ngIf="!isDraftRoute">
                                            <span class="status-badge" [class]="stop.status">
                                                {{ stop.status | titlecase }}{{ stop.type == 'followuprequested' ? ' (Followup)': "" }}
                                            </span>
                                        </div>
                                        <!-- Delete button only shown for draft routes -->
                                        <button *ngIf="routeData.routeStatus == '' || isDraftRoute" 
                                                class="delete-stop-btn" 
                                                (click)="deleteStop(i)"
                                                matTooltip="Delete Stop"
                                                matTooltipPosition="above">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                    </div>
                                </div>
                                <div class="stop-details">
                                    <div class="stop-location">{{ stop.locationName }}</div>
                                    <div class="stop-meta-row">
                                        <div class="stop-eta">ETA {{ stop.eta }}</div>
                                        <div class="stop-otp" *ngIf="stop.deliveryOTP">OTP: {{ stop.deliveryOTP }}</div>
                                        <div class="stop-distance" *ngIf="stop.distance">{{ stop.distance }}</div>
                                    </div>
                                    <div class="stop-inventory-row">
                                        <div class="stop-location-inventory" *ngIf="stop.locationInventory">
                                            <span class="label">Location Inventory:</span>
                                            <span class="value inventory-link" (click)="openStopLocationInventoryModal(stop); $event.stopPropagation()">{{ stop.locationInventory }}</span>
                                        </div>
                                        <div class="stop-shipping-inventory" *ngIf="stop.shippingInventory">
                                            <span class="label">Shipping Inventory:</span>
                                            <span class="value shipping-link" (click)="openStopShippingInventoryModal(stop); $event.stopPropagation()">{{ stop.shippingInventory }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add Stop Button - Only shown for non-draft routes -->
                    <div class="add-stop-section" *ngIf="isDraftRoute || isNotStartedRoute">
                        <button class="btn btn-primary add-stop-btn" (click)="openAddStopModal()">
                            Add Stop
                        </button>
                    </div>
                </div>
</ng-template>

<!-- Add Stop Modal (Location Modal) -->
<div class="modal-overlay" *ngIf="showAddStopModal" (click)="closeAddStopModal()">
    <div class="location-modal-dialog" (click)="$event.stopPropagation()">
        <!-- Radio Button Section -->
        <div class="radio-button-section">
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" 
                           name="locationView" 
                           value="assigned" 
                           [checked]="locationViewType === 'assigned'"
                           (change)="onLocationViewChange('assigned')">
                    <span class="radio-text">Location assign to driver</span>
                </label>
                <label class="radio-option">
                    <input type="radio" 
                           name="locationView" 
                           value="all" 
                           [checked]="locationViewType === 'all'"
                           (change)="onLocationViewChange('all')">
                    <span class="radio-text">All locations</span>
                </label>
            </div>
        </div>
        
        <div class="location-modal-table-wrapper">
            <div class="location-modal-header">
                <div class="header-column">
                    <span class="header-text">LOCATION NAME</span>
                </div>
                <div class="header-column">
                    <span class="header-text">LOCATION ADDRESS</span>
                </div>
                <div class="header-column header-desktop-only">
                    <span class="header-text">DRIVER NAME</span>
                </div>
                <div class="header-column header-desktop-only">
                    <span class="header-text">LOCATION INVENTORY</span>
                </div>
                <div class="header-column header-desktop-only">
                    <span class="header-text">SHIPPING INVENTORY</span>
                </div>
                <div class="header-column">
                    <span class="header-text">STATUS</span>
                </div>
            </div>

            <div class="location-modal-content">
                <div class="customer-list">
                    <div class="customer-item" *ngFor="let customer of customers"
                        (click)="toggleCustomerSelection(customer)">
                        <div class="location-name-column">
                            <mat-icon class="checkbox-icon" [class.checked]="customer.selected">
                                {{customer.selected ? 'check_box' : 'check_box_outline_blank'}}
                            </mat-icon>
                            <div class="location-info">
                                <span class="location-name">{{customer.locationName}}</span>
                                <span class="location-mobile-info">{{customer.driverName}}</span>
                            </div>
                        </div>
                        <div class="location-address-column">
                            <span class="location-address">{{customer.locationAddress}}</span>
                            <div class="mobile-inventory-info">
                                <span class="mobile-inventory" (click)="openLocationInventoryModal(customer, $event)">
                                    Loc: {{customer.locationInventory}}
                                </span>
                                <span class="mobile-shipping" (click)="openLocationShippingModal(customer, $event)">
                                    Ship: {{customer.shippingInventory}}
                                </span>
                            </div>
                        </div>
                        <div class="driver-name-column desktop-only">
                            <span class="driver-name">{{customer.driverName}}</span>
                        </div>
                        <div class="location-inventory-column desktop-only">
                            <span class="inventory-count inventory-link" (click)="openLocationInventoryModal(customer, $event)">{{customer.locationInventory}}</span>
                        </div>
                        <div class="shipping-inventory-column desktop-only">
                            <span class="shipping-count shipping-link" (click)="openLocationShippingModal(customer, $event)">{{customer.shippingInventory}}</span>
                        </div>
                        <div class="customer-status-column">
                            <span class="status-badge" [class.ready-to-ship]="customer.status === 'Ready To Ship'"
                                [class.follow-up]="customer.status === 'Follow up'">
                                {{customer.status}}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="location-modal-footer">
            <button class="create-btn" 
                    (click)="addSelectedCustomersToStops()"
                    [disabled]="!hasSelectedCustomers()">Add Location</button>
        </div>
    </div>
</div>

<!-- Product Details Modal -->
<div class="modal-overlay inventory-modal" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">{{ modalTitle }}</h3>
            <button class="close-btn" (click)="closeModal()">
                <mat-icon>close</mat-icon>
            </button>
        </div>

        <div class="modal-content">
            <div class="modal-table-container">
                <table mat-table [dataSource]="productDetails" class="product-table">
                    <ng-container matColumnDef="productName">
                        <th mat-header-cell *matHeaderCellDef>PRODUCT NAME</th>
                        <td mat-cell *matCellDef="let product">{{product.productName}}</td>
                    </ng-container>

                    <ng-container matColumnDef="skuCode">
                        <th mat-header-cell *matHeaderCellDef>SKU/CODE</th>
                        <td mat-cell *matCellDef="let product">{{product.skuCode}}</td>
                    </ng-container>

                    <ng-container matColumnDef="variantName">
                        <th mat-header-cell *matHeaderCellDef>VARIATION NAME</th>
                        <td mat-cell *matCellDef="let product">{{product.variantName}}</td>
                    </ng-container>

                    <ng-container matColumnDef="quantity">
                        <th mat-header-cell *matHeaderCellDef>IN STOCK</th>
                        <td mat-cell *matCellDef="let product">{{product.quantity}}</td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="productDisplayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: productDisplayedColumns;"></tr>
                </table>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-outline" (click)="closeModal()">Close</button>
        </div>
    </div>
</div>

<!-- Location Inventory Modal -->
<div class="product-modal-overlay" *ngIf="showLocationInventoryModal" (click)="closeLocationInventoryModal()">
  <div class="product-modal-dialog" (click)="$event.stopPropagation()">
    <div class="product-modal-header">
      <h3>{{modalTitle}}</h3>
      <button class="close-btn" (click)="closeLocationInventoryModal()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    
    <div class="product-modal-content">
      <table class="product-table">
        <thead>
          <tr>
            <th>Product Name</th>
            <th>SKU Code</th>
            <th>Variant Name</th>
            <th>Quantity</th>
            <!-- <th>In Stock</th> -->
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let product of selectedLocationInventory">
            <td>{{product.productName}}</td>
            <td>{{product.skuCode}}</td>
            <td>{{product.variantName}}</td>
            <td>{{product.quantity}}</td>
            <!-- <td>{{product.inStock}}</td> -->
          </tr>
        </tbody>
      </table>
    </div>
    
    <div class="modal-footer">
      <button class="close-btn" (click)="closeLocationInventoryModal()">Close</button>
    </div>
  </div>
</div>

<!-- Shipping Inventory Modal -->
<div class="product-modal-overlay" *ngIf="showShippingInventoryModal" (click)="closeShippingInventoryModal()">
  <div class="product-modal-dialog" (click)="$event.stopPropagation()">
    <div class="product-modal-header">
      <h3>{{modalTitle}}</h3>
      <button class="close-btn" (click)="closeShippingInventoryModal()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    
    <div class="product-modal-content">
      <table class="product-table">
        <thead>
          <tr>
            <th>Product Name</th>
            <th>SKU Code</th>
            <th>Variant Name</th>
            <!-- <th>Side</th>
            <th>Colour</th> -->
            <th>Quantity</th>
            <!-- <th>In Stock</th> -->
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let product of selectedShippingInventory">
            <td>{{product.productName}}</td>
            <td>{{product.skuCode}}</td>
            <td>{{product.variantName}}</td>
            <!-- <td>{{product.side}}</td>
            <td>{{product.colour}}</td> -->
            <td>{{product.quantity}}</td>
            <!-- <td>{{product.inStock}}</td> -->
          </tr>
        </tbody>
      </table>
    </div>
    
    <div class="modal-footer">
      <button class="close-btn" (click)="closeShippingInventoryModal()">Close</button>
    </div>
  </div>
</div>