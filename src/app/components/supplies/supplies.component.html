<div class="page-layout">
    <app-sidebar></app-sidebar>
    <div class="main-content">
        <app-header></app-header>
        <div class="content">

            <!-- Page Header -->
            <div class="page-header">
                <h1>Request Supplies</h1>
            </div>

            <div class="table-container">
                <form [formGroup]="suppliesForm" class="user-form" (ngSubmit)="onSubmit()">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Product</label>
                            <div class="product-multiselect-dropdown">
                                <div class="product-multiselect-input" (click)="toggleProductDropdown()">
                                    <span class="product-multiselect-text">{{ getSelectedProductsText() }}</span>
                                    <mat-icon class="product-multiselect-arrow" [class.rotated]="isProductDropdownOpen">keyboard_arrow_down</mat-icon>
                                </div>
                                <div class="product-multiselect-options" *ngIf="isProductDropdownOpen">
                                    <div class="search-wrapper">
                                        <mat-icon class="search-icon">search</mat-icon>
                                        <input 
                                            type="text" 
                                            class="search-input" 
                                            placeholder="Search products..."
                                            [value]="productSearchTerm"
                                            (input)="onProductSearchInput($event); filterProducts()"
                                            (click)="$event.stopPropagation()"
                                        >
                                        <button 
                                            *ngIf="productSearchTerm" 
                                            type="button" 
                                            class="clear-button"
                                            (click)="clearProductSearch(); $event.stopPropagation()"
                                        >
                                            <mat-icon>close</mat-icon>
                                        </button>
                                    </div>
                                    <div *ngIf="loading" class="loading-indicator">
                                        Loading products...
                                    </div>
                                    <div class="product-multiselect-option" *ngFor="let product of getFilteredProducts()" 
                                         (click)="toggleProduct(product.id)">
                                        <input type="checkbox" 
                                               [checked]="isProductSelected(product.id)"
                                               (change)="toggleProduct(product.id)"
                                               class="product-multiselect-checkbox">
                                        <span class="product-multiselect-option-text">{{ product.name }}</span>
                                    </div>
                                    <div *ngIf="getFilteredProducts().length === 0 && !loading" class="no-results">
                                        No products found
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Request Supplier</label>
                            <div class="custom-select-container">
                                <div class="search-wrapper" (click)="showSupplierDropdown = true">
                                    <mat-icon class="search-icon">search</mat-icon>
                                    <input 
                                        type="text" 
                                        class="search-input" 
                                        placeholder="Request Supplier"
                                        [value]="supplierSearchTerm"
                                        (input)="onSupplierSearchInput($event); filterSuppliers()"
                                        (focus)="showSupplierDropdown = true"
                                        (blur)="hideSupplierDropdown()"
                                        [readonly]="selectedSupplier ? true : false"
                                    >
                                    <button 
                                        *ngIf="selectedSupplier" 
                                        type="button" 
                                        class="clear-button"
                                        (click)="clearSupplier(); $event.stopPropagation()"
                                    >
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="dropdown-list" *ngIf="showSupplierDropdown && !selectedSupplier">
                                    <div *ngIf="loading" class="loading-indicator">
                                        Loading suppliers...
                                    </div>
                                    <div 
                                        class="dropdown-item" 
                                        *ngFor="let supplier of getFilteredSuppliers()"
                                        (click)="selectSupplier(supplier)"
                                        [class.selected]="selectedSupplier?.value === supplier.value"
                                    >
                                        {{ supplier.name }}
                                    </div>
                                    <div *ngIf="getFilteredSuppliers().length === 0 && !loading" class="no-results">
                                        No suppliers found
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email Address</label>
                            <input formControlName="email" type="text" placeholder="johndeo@gmail.com" />
                        </div>
                    </div>

                    <!-- All Variation List Table -->
                    <div class="variation-section">
                        <h3 class="variation-title">All Variation list</h3>
                        
                        <!-- Loading indicator for variations -->
                        <div *ngIf="loadingVariations" class="loading-section">
                            <div class="loading-indicator">Loading product variations...</div>
                        </div>
                        
                        <div class="variation-table-wrapper" *ngIf="!loadingVariations">
                            <div class="variation-table-container">
                                <table class="variation-table">
                                <thead>
                                    <tr>
                                        <th>PRODUCT NAME</th>
                                        <th>VARIATION TYPE</th>
                                        <th>VARIATION VALUE</th>
                                        <th>QUANTITY</th>
                                        <th>ACTION</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <ng-container *ngFor="let productData of productVariationTypeData">
                                        <tr *ngFor="let variation of productData.variations; let i = index" class="variation-row">
                                            <!-- <td class="product-name-cell">
                                                <span *ngIf="i === 0" class="product-name">{{ variation.productName }}</span>
                                            </td> -->
                                            <td class="variation-type-cell">{{ variation.productName }}</td>
                                            <td class="variation-type-cell">{{ variation.variationType }}</td>
                                            <td class="variation-value-cell">{{ variation.variationValue }}</td>
                                            <td class="quantity-cell">
                                                <input 
                                                    type="number" 
                                                    class="quantity-input"
                                                    [value]="variation.quantity"
                                                    (input)="updateVariationQuantity(productData.productId, variation.id, +$any($event.target).value)"
                                                    min="0"
                                                    placeholder="0"
                                                />
                                            </td>
                                            <td class="action-cell">
                                                <button 
                                                    type="button"
                                                    class="btn-add"
                                                    (click)="addVariationToSelected(productData.productId, variation)"
                                                    [disabled]="variation.quantity <= 0"
                                                >
                                                    Add
                                                </button>
                                            </td>
                                        </tr>
                                    </ng-container>
                                </tbody>
                            </table>
                            </div>
                            
                            <!-- Show message when no variations available -->
                            <div *ngIf="productVariations.length === 0" class="no-results-section">
                                <p class="no-results-message">No product variations available for selected products.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Product Table -->
                    <div class="selected-section" *ngIf="selectedProducts.length > 0">
                        <h3 class="selected-title">Selected Product</h3>
                        <div class="selected-table-container">
                            <table class="selected-table">
                                <thead>
                                    <tr>
                                        <th>PRODUCT NAME</th>
                                        <th>VARIATION TYPE</th>
                                        <th>VARIATION VALUE</th>
                                        <th>QUANTITY</th>
                                        <th>ACTION</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let selectedProduct of selectedProducts">
                                        <td>{{ selectedProduct.productName }}</td>
                                        <td>{{ selectedProduct.variationType }}</td>
                                        <td>{{ selectedProduct.variationValue }}</td>
                                        <td>{{ selectedProduct.quantity }}</td>
                                        <td>
                                            <span class="status-badge" [class]="getStatusClass(selectedProduct.status)">
                                                {{ getStatusDisplayText(selectedProduct.status) }}
                                                <mat-icon *ngIf="getStatusIcon(selectedProduct.status)" class="status-icon">
                                                    {{ getStatusIcon(selectedProduct.status) }}
                                                </mat-icon>
                                            </span>
                                        </td>
                                        <td>
                                            <button 
                                                type="button"
                                                class="btn-remove"
                                                (click)="removeSelectedProduct(selectedProduct.id)"
                                                title="Remove item"
                                            >
                                                <mat-icon>delete</mat-icon>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Email Template</label>
                            <div class="rich-text-editor">
                                <!-- Toolbar -->
                                <div class="editor-toolbar">
                                    <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" (click)="formatText('bold')" [class.active]="isFormatActive('bold')">
                                            <mat-icon>format_bold</mat-icon>
                                        </button>
                                        <button type="button" class="toolbar-btn" (click)="formatText('italic')" [class.active]="isFormatActive('italic')">
                                            <mat-icon>format_italic</mat-icon>
                                        </button>
                                        <button type="button" class="toolbar-btn" (click)="formatText('underline')" [class.active]="isFormatActive('underline')">
                                            <mat-icon>format_underlined</mat-icon>
                                        </button>
                                    </div>
                                    <div class="toolbar-separator"></div>
                                    <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" (click)="formatText('justifyLeft')" [class.active]="isFormatActive('justifyLeft')">
                                            <mat-icon>format_align_left</mat-icon>
                                        </button>
                                        <button type="button" class="toolbar-btn" (click)="formatText('justifyCenter')" [class.active]="isFormatActive('justifyCenter')">
                                            <mat-icon>format_align_center</mat-icon>
                                        </button>
                                        <button type="button" class="toolbar-btn" (click)="formatText('justifyRight')" [class.active]="isFormatActive('justifyRight')">
                                            <mat-icon>format_align_right</mat-icon>
                                        </button>
                                    </div>
                                    <div class="toolbar-separator"></div>
                                    <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" (click)="formatText('insertUnorderedList')">
                                            <mat-icon>format_list_bulleted</mat-icon>
                                        </button>
                                        <button type="button" class="toolbar-btn" (click)="formatText('insertOrderedList')">
                                            <mat-icon>format_list_numbered</mat-icon>
                                        </button>
                                    </div>
                                    <div class="toolbar-separator"></div>
                                    <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" (click)="insertLink()">
                                            <mat-icon>link</mat-icon>
                                        </button>
                                        <button type="button" class="toolbar-btn" (click)="formatText('removeFormat')">
                                            <mat-icon>format_clear</mat-icon>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Editor Content -->
                                <div 
                                    class="editor-content"
                                    contenteditable="true"
                                    (input)="onEditorInput($event)"
                                    (focus)="onEditorFocus()"
                                    (blur)="onEditorBlur()"
                                    (keyup)="updateToolbarState()"
                                    (mouseup)="updateToolbarState()"
                                    placeholder="Start typing your email template here..."
                                    #editorElement>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Error Message Display -->
                    <div *ngIf="saveError" class="error-message">
                        <mat-icon>error</mat-icon>
                        <span>{{ saveError }}</span>
                    </div>

                    <div class="form-actions">
                        <button type="submit" 
                                class="btn btn-primary" 
                                [disabled]="saving || !suppliesForm.valid || !selectedSupplier">
                            <span *ngIf="saving" class="spinner"></span>
                            <mat-icon *ngIf="saving">hourglass_empty</mat-icon>
                            {{ saving ? 'Saving...' : 'Save' }}
                        </button>
                        <button type="button" 
                                class="btn btn-outline" 
                                (click)="resetForm()" 
                                [disabled]="saving">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal-backdrop" *ngIf="showSuccess">
    <div class="modal-success">
        <div class="modal-icon">
            <mat-icon>check_circle</mat-icon>
        </div>
        <div class="modal-message">
            <h2>Supplies Request Successfully Submitted!</h2>
            <p *ngIf="selectedSupplier">Request sent to: <strong>{{ selectedSupplier.name }}</strong></p>
            <p>Total items requested: <strong>{{ getTotalRequestedItems() }}</strong></p>
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" (click)="addAnotherSupplies()">Add Another Supplies</button>
            <button class="btn btn-outline" (click)="onCancel()">Go to Suppliers List</button>
        </div>
    </div>
</div>